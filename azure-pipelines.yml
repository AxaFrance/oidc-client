# Node.js with React
# Build a Node.js project that uses React.
# Add steps that analyze code, save build artifacts, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/javascript

pool:
  vmImage: 'Ubuntu 16.04'

steps:
- task: NodeTool@0
  inputs:
    versionSpec: '8.x'
  displayName: 'Install Node.js'

- task: SonarSource.sonarqube.15B84CA1-B62F-4A2A-A403-89B77A063157.SonarQubePrepare@4
  displayName: 'Prepare analysis on SonarQube'
  inputs:
    SonarQube: 'SonarCloud'
    projectKey: AxaGuilDEv_react-oidc 
    projectName: react-oidc
    projectVersion: '1.0.0'
    extraProperties: |
     sonar.organization=axaguildev
     sonar.branch.name=$(Build.SourceBranchName)
     sonar.sources=. \
     sonar.host.url=https://sonarcloud.io 
     sonar.login=$(Sonar.Login)
  
- script: |
    npm install
    npm run bootstrap
  displayName: 'npm install and bootstrap'

- script: |
    npm test -- --coverage
    npm run lint
    npm install -g codecov
    codecov
  displayName: 'npm test and lint'

- script: |
    git config --global user.email "build-ci@axa.fr"
    git config --global user.name "Build-CI"
    git reset --hard 
    git remote set-url origin https://$(Github.Token)@github.com/AxaGuilDEv/react-oidc.git 
    git checkout $(Build.SourceBranch)
    node ./scripts/npm.js $(NPM_TOKEN)
    cp .npmrc $HOME/.npmrc
    echo $(Build.SourceBranch)
    git status
  displayName: 'configuration'

- task: SonarSource.sonarqube.6D01813A-9589-4B15-8491-8164AEB38055.SonarQubeAnalyze@4
  displayName: 'Run Code Analysis'

- script: |
    npm run publish -- $(Npm.Publish.Version) --yes --concurrency 1 --force-publish
  displayName: 'lerna publish'
  condition: and(succeeded(), ne(variables['Npm.Publish.Version'], 'none'))


